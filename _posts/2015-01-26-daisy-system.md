---
layout: post
title: 独立游戏聊天系统 - daisy
---

{{ page.title }}
================
## 介绍(Introduction)
网络游戏中的聊天一般有一些特殊的需求，比如在世界频道发言有时间间隔的限制、甚至需要计费；玩家切换场景时需要切换场景相关的会话，但是如果是队伍和帮派等小团体中的聊天，又不会随着玩家切换场景而改变。daisy系统认为这些问题是游戏逻辑的问题，需要游戏逻辑的开发者解决。

为了配合游戏系统实现这种逻辑，daisy把操作分为两类，一类是游戏客户端(game client, gc)直接连接daisy的操作，另一类是游戏服务器(game server, gs)的操作。一般情况下，游戏客户端只需要直接订阅游戏信息，其他操作委托游戏服务器代为完成，使游戏服务器有机会完成游戏相关逻辑。

## 定义（Definitions）
### 实体(Entity)
* 用户(User)
    参与会话的用户，由唯一id（uid，类型为字符串）识别，可以接收与发布信息等
* 对话(Dialog)
    用户之间一对一的会话，不需要显式的创建，用户之间发布第一条消息时自动创建；
* 会议(Conference)
    多个用户参加的会话，需要显式的创建，用户可以加入、退出会议；
* 会话(Session)
    一次对话或者会议的上下文，具有唯一id；对话的id为D@md5(u1:u2)（u1为对话中较小的用户id，u2为另一个用户id），会议的会话ID为C@conferenceid；
* 消息(Message)
    在会话中传输的数据流，支持文本和多媒体；消息的结构为(sessionid, timestamp, sender, receiver, msgid, content)

### 操作(Operation)
* 注册(Register)
    用户使用自己的uid（由其它系统分配，daisy认为相同的uid代表相同的用户）注册到daisy，获得用于订阅信息的token；
* 发送消息(Message)
    发送一条即时聊天信息，若成功，返回一条信息id；
* 订阅信息(Subscribe)
    订阅用户对话和会议中的信息；
* 消息通知(Notify)
    通知订阅者，来了一条新消息
* 消息确认(Ack)
    确认收到消息；客户端收到信息后，根据需求确定是否做本地缓存；

### 会议操作(Conference Operation)
* 创建会议(Create Conference)
* 加入会议(Join Conference)
* 退出会议(Leave Conference)
* 删除会议(Delete Conference)

## 用法(Usage)
daisy监听两个端口，一个（server port)供游戏服务器接入，一个(client port)供游戏客户端接入。
游戏服务器启动后，连接到daisy，创建公共会议，如世界聊天，地图聊天等；根据游戏逻辑，动态创建公会、队伍等会议。daisy服务器保证用相同的名字创建出相同的会议。这样可以确保游戏重启后，可以跟踪到之前的会话历史。
玩家上线后，游戏服务器把玩家加入到响应的会议，并注册玩家，得到订阅信息的token并发给客户端；客户端连接到daisy，订阅玩家的信息流。
玩家发送信息，需要先发送给游戏服务器，游戏服务器根据游戏逻辑处理后，发送到合适的会话上下文。
客户端接收来自daisy的信息，先跟服务器确认收到信息，然后根据sesionid，分发到合适的会话上下文。

## 消息
### 消息结构
daisy中流通的信息分为文本信息，图片信息，语音信息。像微信一样，不支持混排。
发送图片信息和语言信息时，客户端先把多媒体文件上传到web服务器，得到文件的url，然后把url当成文本信息发送给游戏服务器。

### 离线消息
daisy负责缓存每个会话一定数量的客户端未确认信息。
会话中的每条信息都有唯一的自增长编号，daisy保证按照编号由小到大的顺序向客户端发送，当客户端同时收到一个会话中的多条信息时，只需要确认编号最大的那条信息即可。
当客户端确认消息后，daisy可能删除消息。

## 实现
### 协议
### 接口

