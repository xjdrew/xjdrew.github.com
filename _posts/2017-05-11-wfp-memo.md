---
layout: post
title: WFP备忘
---

{{ page.title }}
================

## WFP的定位

WFP用来扩展NDIS Filter引擎的功能，完成更加复杂的数据包操作。

WFP提供的主要扩展机制是Callout Driver。

通过Callout Driver 向Filter 引擎注册一个或者多个Callout。

Filter引擎通过跟Callout关联的Filter规则，来决定何时调用Callout的函数。

每个Filter规则都工作在一个特定的Filter Layer。

WFP预先定义了若干Filter Layer，开发者无法添加和删除Filter Layer。

## WFP架构

*TCP/IP* 网络栈处于硬件设备网卡和用户态软件应用之间。当数据包进入网卡并向上流往用户应用程序时，会经过一系列的网络栈进行封包/解包等处理。WFP使用网络栈中预先定义的一些 *Filtering Layer*，实现对网络包的复杂过滤操作。

![WFP架构图](https://docs.microsoft.com/zh-cn/windows-hardware/drivers/network/images/wfparch.png "WFP架构")

## Filtering Layer

*Filtering Layer* 表示 *TCP/IP* 网络栈中的一个可以过滤的点。

每一个 *Filtering Layer* 可以访问数据包的特定字段。

用户态的 *Filtering Layer* 识别符，每个用128 bit的GUID代表，名字格式 *FWPM_XXX*。列表如下:

[Management Filtering Layer Identifiers](https://msdn.microsoft.com/en-us/library/windows/hardware/ff557101)

内核态的 *Filtering Layer*识别符，每个用64 bit的LUID代表，名字格式 *FWPS_XXX*。列表如下:

[Run-time Filtering Layer Identifiers](https://msdn.microsoft.com/en-us/library/windows/hardware/ff570731)

## Callout

Callout 暴露三个函数供Filter引擎调用。

1. notifyFn

2. classifyFn

3. flowDeleteFn
